<!DOCTYPE html><!--TODO:批量添加-->
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv = "X-UA-Compatible" content = "IE=edge"/>
    <meta name="viewport" content="width=device-width"/>
<!--    <meta http-equiv="Cache-Control" content="no-cache">-->
    <title>用户添加</title>
    <script src="https://cdn.staticfile.org/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/crypto-js/3.3.0/core.min.js"></script>
    <script src="https://cdn.staticfile.org/crypto-js/3.3.0/enc-hex.min.js"></script>
    <script src="https://cdn.staticfile.org/crypto-js/3.3.0/md5.min.js" defer></script>
    <script src="../static/commons.js" defer></script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="../static/iframes.css">
    <script>
        $(document).ready(function () {
            checkLogin(function (d){
                var user=d.info;
                if(user==null||user.role!==0){
                    $("body")[0].innerHTML="<p>您尚未登录！</p><a href='"+_ROOT_+"'>点击返回主页</a>";
                } else {
                    $("#info-form .number").on("keyup paste blur",function () {
                        var val=$(this).val();
                        $(this).val(val.replace(REGEXP_NOT_NUM,''));
                    });
                }
            });
        });
        function submit_() {
            var values=$("#info-form input[type='text'],#info-form input[type='password'],#info-form select");
            var param={},status=$("p.status");
            for(var i=0; i<values.length; i++){
                // console.log(values[i].name,values[i].value);
                param[values[i].name]=values[i].value;
            }
            if(!checkPhone(param.phone)) {
                status.text("手机号格式错误！");
                return FALSE;
            }
            if (!REGEXP_PASS.test(param.pswd)){
                status.text(PASS_REQUIREMENT);
                return FALSE;
            }
            if(!REGEXP_USERNAME.test(param.username)){
                status.text(USERNAME_REQUIREMENT);
                return FALSE;
            }
            param.pswd=hashPassword(param.pswd);
            param.token=Math.round(new Date().getTime()/1000); //时间戳
            $.ajax({
                url:_ROOT_+"user/add.do", type:"post", data:param
            }).done(function (d){
                $("p.status").text(d.msg);
            }).fail(function (xhr) {
                $("p.status").text("出错了，请稍后重试。错误码："+xhr.status);
            }).always(function (){$("#vcode-img").trigger("click");});
            return FALSE;
        }
    </script>
</head>
<body>
<form id="info-form" onsubmit="return submit_()">
    <p><label>用户名：<input type="text" name="username" class="form-control" maxlength="20" autocomplete="off" required/></label></p>
    <p><label>密码：&nbsp;&nbsp;&nbsp;<input type="password" name="pswd" class="form-control" maxlength="20" autocomplete="off" required/></label>
    </p>
    <p><label>姓名：&nbsp;&nbsp;&nbsp;<input type="text" name="truename" class="form-control" maxlength="20" required></label></p>
    <p><label>性别：&nbsp;&nbsp;&nbsp;<select name="gender" class="form-control" required>
        <option value="男">男</option>
        <option value="女">女</option>
    </select>
    </label></p>
    <p><label>手机号：<input type="text" name="phone" class="form-control number" maxlength="11" autocomplete="off" required/></label></p>
    <p><label>身份：&nbsp;&nbsp;&nbsp;<select name="role" class="form-control" required>
        <option value="1">阅览室管理员</option>
        <option value="2">学生</option>
    </select>
    </label></p>
    <p><label>验证码：<input type="text" name="vcode" class="form-control number" maxlength="5" autocomplete="off" required/></label></p>
    <img src="../checkcode" id="vcode-img" onclick="this.src='../checkcode?'+Math.random()" alt="验证码"/><br>
    <input type="submit" class="btn btn-primary" value="提交">
</form>
<p class="status"></p>
</body>
</html>